<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bible Bio - Cinematic Explorer</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons (Lightweight, modern icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #0f172a; /* Slate 900 */
            --secondary-bg: #1e293b; /* Slate 800 */
            --accent-gold: #fbbf24; /* Amber 400 */
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(30, 41, 59, 0.7);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--primary-bg);
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 70%);
            color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1, h2, .font-display {
            font-family: 'Cinzel', serif;
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-button:active {
            transform: scale(0.96);
            background: rgba(255, 255, 255, 0.1);
        }

        /* Bottom Sheet Animation */
        .bottom-sheet {
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .bottom-sheet.open {
            transform: translateY(0);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        /* Loading Pulse */
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0px rgba(251, 191, 36, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); }
        }
        
        .animate-pulse-gold {
            animation: pulse-gold 2s infinite;
        }

        /* Hide scrollbar for horizontal lists */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="text-slate-200">

    <!-- APP CONTAINER -->
    <div class="max-w-md mx-auto min-h-screen relative flex flex-col pb-24 shadow-2xl bg-[#0f172a]">
        
        <!-- HEADER -->
        <header class="p-6 flex justify-between items-center sticky top-0 z-10 bg-[#0f172a]/80 backdrop-blur-md">
            <div>
                <h1 class="text-2xl text-amber-400 font-bold tracking-wider flex items-center gap-2">
                    <i class="ph-fill ph-book-open-text text-3xl"></i> BIBLE BIO
                </h1>
                <p class="text-xs text-slate-400 uppercase tracking-widest mt-1">Cinematic Explorer</p>
            </div>
            <button id="settings-trigger" class="glass-button p-2 rounded-full text-slate-400 hover:text-white">
                <i class="ph ph-gear text-xl"></i>
            </button>
        </header>

        <!-- MAIN SCROLLABLE CONTENT -->
        <main class="flex-grow px-4 pb-8 space-y-8">
            
            <!-- FEATURED / DAILY SECTION -->
            <section class="relative overflow-hidden rounded-2xl glass-panel p-6 shadow-lg border-t border-white/10">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i class="ph-fill ph-sun text-9xl"></i>
                </div>
                <div class="relative z-10">
                    <span class="inline-block px-3 py-1 rounded-full bg-amber-500/20 text-amber-400 text-xs font-bold mb-3 border border-amber-500/30">
                        VERSE OF THE DAY
                    </span>
                    <h2 class="font-display text-xl text-white leading-relaxed mb-4">
                        "For I know the plans I have for you," declares the Lord...
                    </h2>
                    <div class="flex gap-3">
                        <button onclick="app.launchTool('verse-explainer', 'Jeremiah 29:11')" class="flex-1 bg-amber-500 hover:bg-amber-400 text-slate-900 font-bold py-2 rounded-lg transition text-sm">
                            Explain
                        </button>
                        <button onclick="app.launchTool('devotional', new Date().toISOString().split('T')[0])" class="px-4 glass-button rounded-lg text-white">
                            <i class="ph-fill ph-hands-praying text-lg"></i>
                        </button>
                    </div>
                </div>
            </section>

            <!-- QUICK ACTIONS (Horizontal Scroll) -->
            <section>
                <div class="flex justify-between items-end mb-4 px-1">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Quick Look</h3>
                </div>
                <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2">
                    <!-- Dynamic Featured Characters injected here -->
                    <div id="featured-chips" class="flex gap-3"></div>
                </div>
            </section>

            <!-- TOOLS GRID -->
            <section>
                <div class="flex justify-between items-end mb-4 px-1">
                    <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider">Toolbox</h3>
                </div>
                <div id="tools-grid" class="grid grid-cols-2 gap-3">
                    <!-- Tools injected via JS -->
                </div>
            </section>
        </main>
    </div>

    <!-- BOTTOM SHEET OVERLAY (For Forms) -->
    <div id="sheet-overlay" class="fixed inset-0 bg-black/80 z-40 hidden opacity-0 transition-opacity duration-300 backdrop-blur-sm"></div>
    
    <!-- BOTTOM SHEET (TOOL INTERFACE) -->
    <div id="bottom-sheet" class="fixed bottom-0 left-0 right-0 z-50 bg-[#1e293b] rounded-t-3xl shadow-2xl bottom-sheet max-w-md mx-auto border-t border-white/10 max-h-[90vh] flex flex-col">
        <!-- Drag Handle -->
        <div class="w-full flex justify-center pt-4 pb-2" id="sheet-drag-handle">
            <div class="w-12 h-1.5 bg-slate-600 rounded-full"></div>
        </div>

        <!-- Sheet Content -->
        <div class="p-6 pt-2 flex flex-col h-full overflow-y-auto">
            <div class="flex items-center gap-3 mb-6">
                <div id="sheet-icon-container" class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-amber-400 text-xl">
                    <i class="ph ph-sparkle"></i>
                </div>
                <div>
                    <h3 id="sheet-title" class="font-display text-xl text-white">Tool Name</h3>
                    <p id="sheet-desc" class="text-sm text-slate-400">Tool Description goes here.</p>
                </div>
                <button id="close-sheet" class="ml-auto p-2 text-slate-400 hover:text-white">
                    <i class="ph ph-x text-2xl"></i>
                </button>
            </div>

            <!-- Dynamic Form Area -->
            <div id="sheet-form" class="space-y-4 mb-4">
                <!-- Inputs injected here -->
            </div>

            <!-- Action Button -->
            <button id="sheet-action-btn" class="w-full bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-slate-900 font-bold py-4 rounded-xl shadow-lg shadow-amber-900/20 flex items-center justify-center gap-2 text-lg transition-all transform active:scale-[0.98]">
                <span>Generate</span>
                <i class="ph-bold ph-arrow-right"></i>
            </button>
            
            <!-- Safe Area Spacer -->
            <div class="h-8"></div>
        </div>
    </div>

    <!-- FULL SCREEN RESULT MODAL -->
    <div id="result-modal" class="fixed inset-0 z-50 bg-[#0f172a] transform translate-x-full transition-transform duration-300 flex flex-col">
        <!-- Result Header -->
        <div class="flex items-center justify-between p-4 bg-[#1e293b] border-b border-white/5 shadow-md">
            <button id="close-result" class="p-2 text-slate-400 hover:text-white flex items-center gap-1">
                <i class="ph-bold ph-caret-left text-xl"></i> Back
            </button>
            <div class="flex gap-2">
                 <button id="play-audio-btn" class="p-2 rounded-full glass-button text-amber-400 hidden">
                    <i class="ph-fill ph-speaker-high text-xl"></i>
                </button>
                <button id="stop-audio-btn" class="p-2 rounded-full glass-button text-red-400 hidden">
                    <i class="ph-fill ph-stop text-xl"></i>
                </button>
                <button id="copy-btn" class="p-2 rounded-full glass-button text-slate-300">
                    <i class="ph ph-copy text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Result Content -->
        <div class="flex-grow overflow-y-auto p-6">
            <h2 id="result-title" class="font-display text-2xl text-amber-400 mb-6 text-center"></h2>
            <div id="result-body" class="prose prose-invert prose-lg max-w-none font-light leading-relaxed text-slate-200">
                <!-- Content goes here -->
            </div>
            <div class="h-20"></div> <!-- Spacer -->
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center px-4 hidden">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm" id="close-settings-bg"></div>
        <div class="bg-[#1e293b] w-full max-w-sm rounded-2xl p-6 relative z-10 border border-white/10 shadow-2xl">
            <h3 class="font-display text-xl text-white mb-4">App Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-slate-400 mb-2">Google Gemini API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-[#0f172a] border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-amber-500 outline-none transition" placeholder="Paste your API Key here">
                </div>
                <button id="save-settings" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-lg">Save & Close</button>
                <p class="text-xs text-slate-500 text-center">Your key is stored locally on your device.</p>
            </div>
        </div>
    </div>

    <!-- GLOBAL LOADER -->
    <div id="loader" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex flex-col items-center justify-center hidden">
        <div class="w-16 h-16 rounded-full border-4 border-slate-700 border-t-amber-500 animate-spin mb-4"></div>
        <p class="text-amber-400 font-display tracking-widest animate-pulse">DIVINING...</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DEFAULT_API_KEY = ""; // Enter default if you want
        
        // --- DATA & STATE ---
        const tools = [
            {
                id: 'character-search',
                title: 'Character Bio',
                desc: 'Get a concise biography of any biblical figure.',
                icon: 'ph-user-circle',
                color: 'text-emerald-400',
                inputs: [{ name: 'query', type: 'text', placeholder: 'e.g. Moses, Esther, Paul' }],
                prompt: (data) => `Generate a concise biography of the biblical figure "${data.query}". Include their key life events, primary role, and a notable verse. Format plain text.`,
                button: 'Reveal Bio'
            },
            {
                id: 'verse-lookup',
                title: 'Verse Lookup',
                desc: 'Get the exact text of a scripture reference.',
                icon: 'ph-magnifying-glass',
                color: 'text-blue-400',
                inputs: [{ name: 'query', type: 'text', placeholder: 'e.g. John 3:16, Psalm 23' }],
                prompt: (data) => `Provide only the full text for Bible verse "${data.query}". No explanation. Format: Reference on line 1, text on line 2.`,
                button: 'Find Verse'
            },
            {
                id: 'sermon-helper',
                title: 'Sermon Helper',
                desc: 'Generate a structured outline for study or preaching.',
                icon: 'ph-microphone-stage',
                color: 'text-purple-400',
                inputs: [{ name: 'topic', type: 'text', placeholder: 'e.g. The Grace of God' }],
                prompt: (data) => `Generate a detailed sermon outline for: "${data.topic}". Include Title, Scripture, Intro, 3 Main Points, Illustration, Conclusion. Plain text.`,
                button: 'Create Outline'
            },
            {
                id: 'parable-explainer',
                title: 'Parable Explainer',
                desc: 'Deep dive into the meaning of Jesus\' stories.',
                icon: 'ph-plant',
                color: 'text-green-400',
                inputs: [{ name: 'parable', type: 'text', placeholder: 'e.g. The Prodigal Son' }],
                prompt: (data) => `Explain the parable of "${data.parable}". Sections: Story, Context, Spiritual Meaning. Plain text.`,
                button: 'Explain Parable'
            },
            {
                id: 'devotional',
                title: 'Daily Devotional',
                desc: 'A moment of reflection for a specific day.',
                icon: 'ph-sun-horizon',
                color: 'text-amber-400',
                inputs: [{ name: 'date', type: 'date', placeholder: '' }],
                prompt: (data) => `Generate a short, inspiring devotional for ${data.date}. Include a verse, reflection, and one-sentence prayer. Plain text.`,
                button: 'Generate Devotional',
                ttsPrefix: "Here is your devotional for today. "
            },
            {
                id: 'theologian',
                title: 'Ask a Theologian',
                desc: 'Get clear answers to complex questions.',
                icon: 'ph-student',
                color: 'text-cyan-400',
                inputs: [{ name: 'question', type: 'text', placeholder: 'e.g. Explain the Trinity' }],
                prompt: (data) => `Act as a clear theologian. Answer: "${data.question}". Use analogies and scripture. Plain text.`,
                button: 'Ask Question'
            },
            {
                id: 'verse-explainer',
                title: 'Verse Explainer',
                desc: 'Detailed breakdown of context and meaning.',
                icon: 'ph-book-bookmark',
                color: 'text-rose-400',
                inputs: [{ name: 'verse', type: 'text', placeholder: 'e.g. Romans 8:28' }],
                prompt: (data) => `Explain verse "${data.verse}". Sections: Context, Key Terms, Meaning, Application. Plain text.`,
                button: 'Analyze Verse'
            },
            {
                id: 'prayer-generator',
                title: 'Prayer Generator',
                desc: 'Find the words when you can\'t speak.',
                icon: 'ph-hands-praying',
                color: 'text-indigo-400',
                inputs: [{ name: 'need', type: 'text', placeholder: 'e.g. For strength, For anxiety' }],
                prompt: (data) => `Write a heartfelt prayer for: "${data.need}". 3-4 sentences. Respectful and personal. Plain text.`,
                button: 'Compose Prayer'
            },
            {
                id: 'dialogue',
                title: 'Biblical Dialogue',
                desc: 'Imagine a conversation between two figures.',
                icon: 'ph-chats-circle',
                color: 'text-orange-400',
                inputs: [
                    { name: 'char1', type: 'text', placeholder: 'Character 1 (e.g. David)' },
                    { name: 'char2', type: 'text', placeholder: 'Character 2 (e.g. Solomon)' }
                ],
                prompt: (data) => `Write a hypothetical dialogue between ${data.char1} and ${data.char2}. Theologically sound. Script format.`,
                button: 'Create Dialogue'
            },
            {
                id: 'storyteller',
                title: 'Storyteller (Kids)',
                desc: 'Simple stories with audio for children.',
                icon: 'ph-baby',
                color: 'text-pink-400',
                inputs: [{ name: 'story', type: 'text', placeholder: 'e.g. Daniel in the Lions\' Den' }],
                prompt: (data) => `Retell the Bible story "${data.story}" for a 5-year-old. Simple, vivid, moral focus. Plain text.`,
                button: 'Tell Story',
                ttsPrefix: "Let me tell you a story. "
            }
        ];

        const featuredCharacters = [
            { name: "David", query: "David" },
            { name: "Esther", query: "Esther" },
            { name: "Paul", query: "Paul" },
            { name: "Ruth", query: "Ruth" },
            { name: "Peter", query: "Peter" }
        ];

        let currentAudio = null;
        let activeTool = null;

        // --- CORE APP LOGIC ---

        const app = {
            init: () => {
                app.renderTools();
                app.renderFeatured();
                app.setupListeners();
                
                // Check local storage for API key
                const storedKey = localStorage.getItem('gemini_api_key');
                if (storedKey) {
                    document.getElementById('api-key-input').value = storedKey;
                } else if(DEFAULT_API_KEY) {
                    document.getElementById('api-key-input').value = DEFAULT_API_KEY;
                }
            },

            renderTools: () => {
                const grid = document.getElementById('tools-grid');
                grid.innerHTML = tools.map(tool => `
                    <div onclick="app.openSheet('${tool.id}')" class="glass-panel p-4 rounded-xl flex flex-col items-center justify-center text-center gap-2 cursor-pointer hover:bg-white/5 active:scale-95 transition-all h-32 border border-white/5 shadow-lg group relative overflow-hidden">
                         <div class="absolute inset-0 bg-gradient-to-tr from-transparent to-white/5 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <i class="ph-fill ${tool.icon} text-3xl ${tool.color} mb-1 drop-shadow-md"></i>
                        <h4 class="font-bold text-sm text-slate-200">${tool.title}</h4>
                        <p class="text-[10px] text-slate-400 leading-tight line-clamp-2">${tool.desc}</p>
                    </div>
                `).join('');
            },

            renderFeatured: () => {
                const container = document.getElementById('featured-chips');
                container.innerHTML = featuredCharacters.map(char => `
                    <button onclick="app.launchTool('character-search', '${char.query}')" class="glass-button px-4 py-2 rounded-full whitespace-nowrap text-sm font-medium text-slate-300 hover:bg-white/10 hover:text-amber-400 transition-colors border border-white/10">
                        ${char.name}
                    </button>
                `).join('');
            },

            setupListeners: () => {
                // Sheet closing
                document.getElementById('close-sheet').addEventListener('click', app.closeSheet);
                document.getElementById('sheet-overlay').addEventListener('click', app.closeSheet);
                
                // Result Modal
                document.getElementById('close-result').addEventListener('click', app.closeResult);
                
                // Settings
                document.getElementById('settings-trigger').addEventListener('click', () => {
                    document.getElementById('settings-modal').classList.remove('hidden');
                });
                document.getElementById('close-settings-bg').addEventListener('click', () => {
                    document.getElementById('settings-modal').classList.add('hidden');
                });
                document.getElementById('save-settings').addEventListener('click', () => {
                    const key = document.getElementById('api-key-input').value.trim();
                    localStorage.setItem('gemini_api_key', key);
                    document.getElementById('settings-modal').classList.add('hidden');
                });

                // Audio
                document.getElementById('stop-audio-btn').addEventListener('click', app.stopAudio);
                
                // Action Button
                document.getElementById('sheet-action-btn').addEventListener('click', app.handleAction);

                // Copy Button
                document.getElementById('copy-btn').addEventListener('click', () => {
                    const text = document.getElementById('result-body').innerText;
                    navigator.clipboard.writeText(text);
                    const icon = document.getElementById('copy-btn').querySelector('i');
                    icon.classList.remove('ph-copy');
                    icon.classList.add('ph-check', 'text-green-400');
                    setTimeout(() => {
                        icon.classList.add('ph-copy');
                        icon.classList.remove('ph-check', 'text-green-400');
                    }, 2000);
                });
            },

            openSheet: (toolId) => {
                activeTool = tools.find(t => t.id === toolId);
                if (!activeTool) return;

                // Populate Sheet Info
                document.getElementById('sheet-title').innerText = activeTool.title;
                document.getElementById('sheet-desc').innerText = activeTool.desc;
                document.getElementById('sheet-icon-container').innerHTML = `<i class="ph-fill ${activeTool.icon}"></i>`;
                
                // Render Inputs
                const formContainer = document.getElementById('sheet-form');
                formContainer.innerHTML = activeTool.inputs.map(input => `
                    <div>
                        <input type="${input.type}" 
                               id="input-${input.name}" 
                               class="w-full bg-[#0f172a] border border-slate-700 rounded-xl px-4 py-4 text-white placeholder-slate-500 focus:ring-2 focus:ring-amber-500 focus:border-amber-500 outline-none transition shadow-inner" 
                               placeholder="${input.placeholder}"
                               value="${input.type === 'date' ? new Date().toISOString().split('T')[0] : ''}"
                        >
                    </div>
                `).join('');
                
                // Update Button Text
                document.getElementById('sheet-action-btn').innerHTML = `<span>${activeTool.button}</span> <i class="ph-bold ph-arrow-right"></i>`;

                // Show Sheet
                document.getElementById('sheet-overlay').classList.remove('hidden');
                setTimeout(() => document.getElementById('sheet-overlay').classList.remove('opacity-0'), 10);
                document.getElementById('bottom-sheet').classList.add('open');
            },

            closeSheet: () => {
                document.getElementById('bottom-sheet').classList.remove('open');
                document.getElementById('sheet-overlay').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('sheet-overlay').classList.add('hidden');
                }, 300);
            },

            // For launching a tool directly with data (Quick Chips)
            launchTool: (toolId, prefillData) => {
                app.openSheet(toolId);
                // Wait for DOM update then fill
                setTimeout(() => {
                    const input = document.querySelector('#sheet-form input');
                    if(input) input.value = prefillData;
                }, 50);
            },

            handleAction: async () => {
                if (!activeTool) return;
                
                // Gather data
                const data = {};
                let isValid = true;
                activeTool.inputs.forEach(input => {
                    const val = document.getElementById(`input-${input.name}`).value.trim();
                    if (!val) isValid = false;
                    data[input.name] = val;
                });

                if (!isValid) {
                    alert('Please fill in all fields.');
                    return;
                }

                // Show Loader
                document.getElementById('loader').classList.remove('hidden');
                app.closeSheet(); // Close sheet while loading

                try {
                    const prompt = activeTool.prompt(data);
                    const response = await api.generateText(prompt);
                    
                    app.showResult(activeTool.title, response);
                } catch (error) {
                    alert('Error: ' + error.message);
                } finally {
                    document.getElementById('loader').classList.add('hidden');
                }
            },

            showResult: (title, content) => {
                const modal = document.getElementById('result-modal');
                document.getElementById('result-title').innerText = title;
                
                // Format content (simple markdown-like parser for bolding)
                let formatted = content.replace(/\*\*(.*?)\*\*/g, '<strong class="text-amber-400">$1</strong>');
                formatted = formatted.replace(/\n/g, '<br>');
                
                document.getElementById('result-body').innerHTML = formatted;
                
                // Audio Logic
                const playBtn = document.getElementById('play-audio-btn');
                const stopBtn = document.getElementById('stop-audio-btn');
                
                // Clean up old audio
                app.stopAudio();

                if (activeTool.id === 'devotional' || activeTool.id === 'storyteller') {
                    playBtn.classList.remove('hidden');
                    stopBtn.classList.add('hidden');
                    
                    // Setup new play listener with closure to current content
                    playBtn.onclick = async () => {
                        playBtn.classList.add('animate-pulse');
                        const prefix = activeTool.ttsPrefix || "";
                        // Strip html for TTS
                        const plainText = document.getElementById('result-body').innerText;
                        try {
                            const audioData = await api.generateSpeech(prefix + plainText);
                            app.playAudio(audioData.audioData, audioData.mimeType);
                            playBtn.classList.add('hidden');
                            stopBtn.classList.remove('hidden');
                        } catch(e) {
                            alert("Audio generation failed: " + e.message);
                        } finally {
                            playBtn.classList.remove('animate-pulse');
                        }
                    };
                } else {
                    playBtn.classList.add('hidden');
                    stopBtn.classList.add('hidden');
                }

                modal.classList.remove('translate-x-full');
            },

            closeResult: () => {
                document.getElementById('result-modal').classList.add('translate-x-full');
                app.stopAudio();
            },

            playAudio: async (base64Data, mimeType) => {
                app.stopAudio();
                const binaryString = window.atob(base64Data);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) bytes[i] = binaryString.charCodeAt(i);
                
                const blob = new Blob([bytes], { type: 'audio/wav' }); // Approximation
                const url = URL.createObjectURL(blob);
                currentAudio = new Audio(url);
                currentAudio.play();
                currentAudio.onended = () => {
                     document.getElementById('stop-audio-btn').classList.add('hidden');
                     document.getElementById('play-audio-btn').classList.remove('hidden');
                };
            },

            stopAudio: () => {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio = null;
                }
                document.getElementById('stop-audio-btn').classList.add('hidden');
                const playBtn = document.getElementById('play-audio-btn');
                if (activeTool && (activeTool.id === 'devotional' || activeTool.id === 'storyteller')) {
                    playBtn.classList.remove('hidden');
                }
            }
        };

        // --- API LOGIC ---
        const api = {
            getKey: () => {
                const key = localStorage.getItem('gemini_api_key') || document.getElementById('api-key-input').value;
                if (!key) throw new Error("Please set your API Key in the settings (Gear icon).");
                return key;
            },

            generateText: async (prompt) => {
                const key = api.getKey();
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error("API Error: " + response.status);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response generated.";
            },

            generateSpeech: async (text) => {
                const key = api.getKey();
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } }
                        }
                    })
                });

                if (!response.ok) throw new Error("TTS Error");
                const data = await response.json();
                const part = data.candidates?.[0]?.content?.parts?.[0];
                return { audioData: part.inlineData.data, mimeType: part.inlineData.mimeType };
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', app.init);

    </script>
</body>
</html>
